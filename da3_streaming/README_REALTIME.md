# DA3 å®æ—¶ç‚¹äº‘é‡å»ºæ¼”ç¤ºç³»ç»Ÿ

è¿™æ˜¯ä¸€ä¸ªå®Œæ•´çš„å®æ—¶streamingç‚¹äº‘é‡å»ºæ¼”ç¤ºç³»ç»Ÿï¼Œæ”¯æŒä»ZMQè§†é¢‘æµå®æ—¶æ•è·ã€å¤„ç†å¹¶å¢é‡æ˜¾ç¤º3Dç‚¹äº‘ã€‚

## ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     ZMQ Stream      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è§†é¢‘æµå‘å¸ƒå™¨     â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚  DA3æœåŠ¡ç«¯       â”‚
â”‚ (rgb_zmq_       â”‚                     â”‚ (Flask+WebSocket)â”‚
â”‚  publisher.py)  â”‚                     â”‚                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚  - æ¥æ”¶è§†é¢‘æµ     â”‚
                                        â”‚  - DA3å¤„ç†       â”‚
                                        â”‚  - ç”ŸæˆPLY      â”‚
                                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                 â”‚ WebSocket
                                                 â”‚ REST API
                                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                        â”‚   å‰ç«¯ç½‘é¡µ       â”‚
                                        â”‚ (Three.js)      â”‚
                                        â”‚                  â”‚
                                        â”‚  - å®æ—¶æ¸²æŸ“      â”‚
                                        â”‚  - å¢é‡æ›´æ–°      â”‚
                                        â”‚  - äº¤äº’æ§åˆ¶      â”‚
                                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## åŠŸèƒ½ç‰¹æ€§

### ğŸ¥ å®æ—¶è§†é¢‘æµå¤„ç†
- ä»ZMQè®¢é˜…å®æ—¶è§†é¢‘æµ
- è‡ªåŠ¨ç¼“å­˜æ¥æ”¶åˆ°çš„å¸§
- è¾¾åˆ°chunkå¤§å°åè‡ªåŠ¨è§¦å‘å¤„ç†

### ğŸ§  å¢é‡DA3å¤„ç†
- åˆ†å—å¤„ç†è§†é¢‘å¸§
- å®æ—¶æ·±åº¦ä¼°è®¡å’Œç‚¹äº‘ç”Ÿæˆ
- chunké—´è‡ªåŠ¨å¯¹é½ï¼ˆSim3å˜æ¢ï¼‰
- å†…å­˜ä¼˜åŒ–çš„æµå¼å¤„ç†

### ğŸ¨ å®æ—¶3Dæ¸²æŸ“
- åŸºäºThree.jsçš„WebGLæ¸²æŸ“
- å¢é‡åŠ è½½å’Œæ˜¾ç¤ºç‚¹äº‘
- æµç•…çš„äº¤äº’æ§åˆ¶ï¼ˆæ—‹è½¬ã€ç¼©æ”¾ã€å¹³ç§»ï¼‰
- ç¾è§‚çš„UIè®¾è®¡

### ğŸ”„ å›ç¯ä¼˜åŒ–
- åœæ­¢æ•è·åè‡ªåŠ¨æ‰§è¡Œå›ç¯æ£€æµ‹
- ä¼˜åŒ–å…¨å±€ä¸€è‡´æ€§
- æ˜¾ç¤ºæœ€ç»ˆä¿®æ­£åçš„ç‚¹äº‘

## å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…ä¾èµ–

```bash
pip install -r requirements_realtime.txt
```

### 2. å¯åŠ¨è§†é¢‘æµå‘å¸ƒå™¨

é¦–å…ˆéœ€è¦æœ‰ä¸€ä¸ªZMQè§†é¢‘æµå‘å¸ƒå™¨ï¼ˆæ¯”å¦‚ `rgb_zmq_publisher.py`ï¼‰:

```bash
python3 rgb_zmq_publisher.py --port 5555 --source <video_file_or_camera>
```

### 3. å¯åŠ¨DA3å®æ—¶æœåŠ¡

ä½¿ç”¨æä¾›çš„è„šæœ¬ï¼š

```bash
bash start_realtime_demo.sh
```

æˆ–è€…æ‰‹åŠ¨å¯åŠ¨ï¼š

```bash
python3 da3_realtime_service.py --host 0.0.0.0 --port 5000
```

### 4. æ‰“å¼€ç½‘é¡µ

åœ¨æµè§ˆå™¨ä¸­è®¿é—®ï¼š

```
http://localhost:5000
```

### 5. å¼€å§‹æ‰«æ

1. åœ¨ç½‘é¡µä¸Šé…ç½®ZMQåœ°å€å’Œç«¯å£
2. ç‚¹å‡»"å¼€å§‹æ‰«æ"æŒ‰é’®
3. ç³»ç»Ÿå°†è‡ªåŠ¨æ¥æ”¶è§†é¢‘æµå¹¶å®æ—¶å¤„ç†
4. ç‚¹äº‘ä¼šå¢é‡åœ°æ˜¾ç¤ºåœ¨3Dè§†å›¾ä¸­
5. ç‚¹å‡»"åœæ­¢å¹¶å›ç¯ä¼˜åŒ–"å®Œæˆæ‰«æ
6. ç­‰å¾…å›ç¯ä¼˜åŒ–å®Œæˆåï¼ŒæŸ¥çœ‹æœ€ç»ˆç»“æœ

## APIæ¥å£

### REST API

#### POST /api/start
å¼€å§‹è§†é¢‘æµæ•è·å’Œå¤„ç†

**è¯·æ±‚ä½“:**
```json
{
    "zmq_host": "127.0.0.1",
    "zmq_port": 5555,
    "config": "./configs/base_config.yaml"
}
```

**å“åº”:**
```json
{
    "status": "started",
    "output_dir": "./exps/realtime/2025-12-18-16-30-00",
    "config": "./configs/base_config.yaml"
}
```

#### POST /api/stop
åœæ­¢æ•è·å¹¶å¼€å§‹å›ç¯ä¼˜åŒ–

**å“åº”:**
```json
{
    "status": "stopped",
    "total_frames": 120,
    "total_chunks": 3
}
```

#### GET /api/status
è·å–å½“å‰çŠ¶æ€

**å“åº”:**
```json
{
    "is_running": true,
    "is_processing": false,
    "status": "capturing",
    "frame_count": 45,
    "chunk_count": 1,
    "output_dir": "./exps/realtime/2025-12-18-16-30-00"
}
```

#### GET /pointcloud/{chunk_id}
ä¸‹è½½æŒ‡å®šchunkçš„ç‚¹äº‘æ–‡ä»¶

#### GET /pointcloud/final
ä¸‹è½½æœ€ç»ˆåˆå¹¶çš„ç‚¹äº‘æ–‡ä»¶

### WebSocketäº‹ä»¶

#### æœåŠ¡ç«¯ -> å®¢æˆ·ç«¯

- `connection_established`: è¿æ¥å»ºç«‹
- `frame_captured`: æ–°å¸§æ•è· `{frame_count, timestamp}`
- `processing_started`: å¼€å§‹å¤„ç†chunk `{chunk_id, frame_count}`
- `chunk_ready`: chunkå¤„ç†å®Œæˆ `{chunk_id, ply_path, ply_url}`
- `loop_closure_started`: å¼€å§‹å›ç¯ä¼˜åŒ– `{total_chunks, total_frames}`
- `loop_closure_finished`: å›ç¯ä¼˜åŒ–å®Œæˆ `{final_ply_url, final_ply_path}`
- `error`: é”™è¯¯ä¿¡æ¯ `{message}`

## é…ç½®è¯´æ˜

ç³»ç»Ÿä½¿ç”¨æ ‡å‡†çš„DA3é…ç½®æ–‡ä»¶ï¼ˆ`configs/base_config.yaml`ï¼‰ï¼Œå…³é”®é…ç½®é¡¹ï¼š

```yaml
Model:
  chunk_size: 40              # æ¯ä¸ªchunkçš„å¸§æ•°
  overlap: 10                 # chunké—´é‡å å¸§æ•°
  loop_enable: true           # æ˜¯å¦å¯ç”¨å›ç¯æ£€æµ‹
  align_method: "scale+se3"   # å¯¹é½æ–¹æ³•
  
Pointcloud_Save:
  conf_threshold_coef: 0.5    # ç½®ä¿¡åº¦é˜ˆå€¼ç³»æ•°
  sample_ratio: 0.3           # ç‚¹äº‘é‡‡æ ·ç‡
```

## æ–‡ä»¶ç»“æ„

```
da3_streaming/
â”œâ”€â”€ da3_realtime_service.py          # FlaskæœåŠ¡ç«¯
â”œâ”€â”€ da3_streaming_realtime.py        # å®æ—¶å¤„ç†ç±»
â”œâ”€â”€ start_realtime_demo.sh           # å¯åŠ¨è„šæœ¬
â”œâ”€â”€ requirements_realtime.txt        # ä¾èµ–åˆ—è¡¨
â”œâ”€â”€ templates/
â”‚   â””â”€â”€ index.html                   # å‰ç«¯ç½‘é¡µ
â”œâ”€â”€ configs/
â”‚   â””â”€â”€ base_config.yaml             # é…ç½®æ–‡ä»¶
â””â”€â”€ exps/
    â””â”€â”€ realtime/                    # è¾“å‡ºç›®å½•
        â””â”€â”€ YYYY-MM-DD-HH-MM-SS/
            â”œâ”€â”€ frames/              # æ•è·çš„å¸§
            â”œâ”€â”€ pcd/                 # ç”Ÿæˆçš„ç‚¹äº‘
            â””â”€â”€ _tmp_*/              # ä¸´æ—¶æ–‡ä»¶
```

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **GPU**: ç¡®ä¿CUDAå¯ç”¨ï¼ŒDA3å¤„ç†éœ€è¦GPUåŠ é€Ÿ
2. **å†…å­˜**: chunk_sizeè¶Šå¤§ï¼Œå†…å­˜å ç”¨è¶Šé«˜ï¼Œå»ºè®®æ ¹æ®GPUæ˜¾å­˜è°ƒæ•´
3. **ç½‘ç»œ**: ä½¿ç”¨æœ¬åœ°ZMQè¿æ¥ä»¥å‡å°‘å»¶è¿Ÿ
4. **é‡‡æ ·ç‡**: é™ä½`sample_ratio`å¯ä»¥å‡å°‘ç‚¹äº‘å¤§å°ï¼Œæé«˜æ¸²æŸ“æ€§èƒ½

## æ•…éšœæ’é™¤

### é—®é¢˜: æ— æ³•æ¥æ”¶ZMQè§†é¢‘æµ
- æ£€æŸ¥ZMQå‘å¸ƒå™¨æ˜¯å¦æ­£å¸¸è¿è¡Œ
- ç¡®è®¤ä¸»æœºåœ°å€å’Œç«¯å£é…ç½®æ­£ç¡®
- æ£€æŸ¥é˜²ç«å¢™è®¾ç½®

### é—®é¢˜: DA3å¤„ç†é€Ÿåº¦æ…¢
- ç¡®è®¤CUDAå¯ç”¨: `torch.cuda.is_available()`
- å‡å°chunk_size
- æ£€æŸ¥GPUæ˜¾å­˜æ˜¯å¦å……è¶³

### é—®é¢˜: ç‚¹äº‘æ¸²æŸ“å¡é¡¿
- é™ä½ç‚¹äº‘é‡‡æ ·ç‡ï¼ˆsample_ratioï¼‰
- å‡å°æµè§ˆå™¨çª—å£å¤§å°
- ä½¿ç”¨æ€§èƒ½æ›´å¥½çš„GPU

### é—®é¢˜: å›ç¯ä¼˜åŒ–å¤±è´¥
- ç¡®ä¿åœºæ™¯æœ‰è¶³å¤Ÿçš„é‡å åŒºåŸŸ
- æ£€æŸ¥loop_enableé…ç½®
- æŸ¥çœ‹æ—¥å¿—ä¸­çš„é”™è¯¯ä¿¡æ¯

## æŠ€æœ¯æ ˆ

- **åç«¯**: Flask, Flask-SocketIO, PyZMQ
- **æ·±åº¦å­¦ä¹ **: PyTorch, Depth-Anything-3
- **å‰ç«¯**: Three.js, Socket.IO
- **å›¾åƒå¤„ç†**: OpenCV, NumPy

## è®¸å¯è¯

Apache License 2.0

## è‡´è°¢

åŸºäº [Depth-Anything-3](https://github.com/DepthAnything/Depth-Anything-V3) å’Œ DA3-Streaming é¡¹ç›®å¼€å‘ã€‚

